<bindings xmlns="http://www.mozilla.org/xbl"
          xmlns:xbl="http://www.mozilla.org/xbl"
          xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
  <binding id="forceWindowedFlashPlayer" bindToUntrustedContent="true">
    <implementation>
      <constructor>
      <![CDATA[
        let plugin = this;
        let wmode = plugin.getAttribute("wmode") || (function() {
          let params = plugin.querySelectorAll("param[name]");
          for (let i = 0, l = params.length; i < l; i++) {
            let param = params[i];
            if (param.getAttribute("name").toLowerCase() === "wmode")
              return param.getAttribute("value");
          }
          return "";
        })();
        //console.log("[FlashGestures] Flash player detected, wmode = " + (wmode || "(default)"));
        
        wmode = wmode.toLowerCase();
        if (wmode === "opaque" || wmode === "transparent") {
          let preferredWmode = "direct";
          if (plugin.hasAttribute("wmode")) {
            plugin.setAttribute("wmode", preferredWmode);
          } else {
            let params = plugin.querySelectorAll("param[name]");
            for (let i = 0, l = params.length; i < l; i++) {
              let param = params[i];
              if (param.getAttribute("name").toLowerCase() === "wmode") {
                param.setAttribute("value", preferredWmode);
                break;
              }
            }
          }
          //console.log("[FlashGestures] Forced into wmode = " + preferredWmode);
        }
        
        // Self-"unbind"ing
        // This does not actually remove the binding, however. But it does allow other bindings 
        // to be attached to plugin elements. See
        // https://ask.mozilla.org/question/297/apply-and-remove-xbl-binding-on-runtime/
        // for details.
        plugin.classList.add("flashgestures-forced-window");
      ]]>
      </constructor>
    </implementation>
  </binding>
  <binding id="forceWindowedSilverlight" bindToUntrustedContent="true">
    <implementation>
      <constructor>
      <![CDATA[
        let plugin = this;
        let windowless = plugin.getAttribute("windowless") || (function() {
          let param = plugin.querySelector("param[name=\"windowless\"]");
          return param ? param.getAttribute("value") : "";
        })();
        
        windowless = windowless.toLowerCase();
        if (windowless === "true") {
          let preferredWindowless = "false";
          if (plugin.hasAttribute("windowless")) {
            plugin.setAttribute("windowless", preferredWindowless);
          } else {
            let param = plugin.querySelector("param[name=\"windowless\"]");
            if (param)
              param.setAttribute("value", preferredWindowless);
          }
        }
        
        // Self-unbinding
        plugin.classList.add("flashgestures-forced-window");
      ]]>
      </constructor>
    </implementation>
  </binding>
</bindings>
